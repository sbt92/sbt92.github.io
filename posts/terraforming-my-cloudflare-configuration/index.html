<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="The personal website of Sam Tripp"><link rel="shortcut icon" href=https://www.samtripp.co.uk/favicon.ico><link rel=stylesheet href=/css/style.min.css><link rel=canonical href=https://www.samtripp.co.uk/posts/terraforming-my-cloudflare-configuration/><title>Terraforming my Cloudflare configuration</title></head><body><header id=banner><h2><a href=https://www.samtripp.co.uk>Sam Tripp</a></h2><nav><ul><li><a href=/ title=posts>posts</a></li><li><a href=/about/ title=about>about</a></li><li><a href=/posts/index.xml title=rss>rss</a></li></ul></nav></header><main id=content><article><header id=post-header><h1>Terraforming my Cloudflare configuration</h1><div><time>29 April 2024</time></div></header><p>A couple of weeks ago I was having a conversation with a friend regarding Cloudflare. He was saying how it is not uncommon for people to make configuration changes using the Cloudflare UI potentially introducing breaking changes that could go unnoticed. I meantioned that with Infrastructure-as-Code implemented there is no excuse for this to happen. I also came to a realisation that I do not practice what I preached so to rectify this I have decided to capture my Cloudflare configuration into my Infrastructure-as-Code tool of choice Terraform.</p><p>Cloudflare handles a number of things for me on this domain but most notably it handles my DNS records for this website and my emails. An outages of either of these would not be ideal for me so to avoid this we are going to use <a href=https://github.com/cloudflare/cf-terraforming>cf-terraforming</a> to generate Terraform code based on my current DNS configuration in the Cloudflare UI and to generate the terraform import commands so I can import my Cloudflare configuration into my Terraform state.</p><h1 id=building-the-application>Building the application</h1><p>Unfortunately cf-terraforming is not packaged in the Debian repositories and there is no flatpak or snap availible for it so we do have to resort to building it. If you&rsquo;re following along on a Macbook there is a brew package for this which would save some time. Fortunately building this was incredibly straigtforward:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>git clone https://github.com/cloudflare/cf-terraforming.git
</span></span><span class=line><span class=cl><span class=nb>cd</span> cf-terraforming
</span></span><span class=line><span class=cl>make build
</span></span></code></pre></div><p>There may be some dependancies that need to be installed such as the Go programming language but I already had this on my laptop. Once the make command has successfully ran a binary file will appear in the same directory called cf-terraforming. I was able to interact with this binary in the terminal by running <code>./cf-terraforming</code></p><h1 id=create-cloudflare-api-token-with-sufficiant-permissions>Create Cloudflare API token with sufficiant permissions</h1><p>I needed to create a Cloudflare API token so cf-terraforming and Terraform can interact with Cloudflare. To do this I navigate to the <a href=https://dash.cloudflare.com/profile/api-tokens>Cloudflare API Token page</a>, Select create token and then create custom token. Give the token sufficiant privalages to do what I needed it to do. For the purpose of DNS I selected Zone DNS Edit from the permissions dropdown and under the Zone Resource dropdown I selected Include Specific Zone samtripp.co.uk. I then followed the rest of the wizard to create my API Token.</p><p>Once this was created I was able to export my API Token along with my zone id which can be found on the Cloudflare dashboard onto my laptop as an environment varible in my terminal</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=nb>export</span> <span class=nv>CLOUDFLARE_API_TOKEN</span><span class=o>=</span><span class=s1>&#39;YOURAPITOKEN&#39;</span>
</span></span><span class=line><span class=cl><span class=nb>export</span> <span class=nv>CLOUDFLARE_ZONE_ID</span><span class=o>=</span><span class=s1>&#39;YOURZONEID&#39;</span>
</span></span></code></pre></div><h1 id=initialise-terraform-working-directory-with-cloudflare-module-present>Initialise Terraform working directory with Cloudflare module present</h1><p>To start using the cf-terraforming tool I need to add the <a href=https://registry.terraform.io/providers/cloudflare/cloudflare/latest/docs>Cloudflare provider</a> to my terraform code. I created a <code>cloudflare.tf</code> file and added the following</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>terraform</span> {
</span></span><span class=line><span class=cl>  <span class=k>required_providers</span> {
</span></span><span class=line><span class=cl><span class=n>    cloudflare</span> <span class=o>=</span> {
</span></span><span class=line><span class=cl><span class=n>      source</span>  <span class=o>=</span> <span class=s2>&#34;cloudflare/cloudflare&#34;</span>
</span></span><span class=line><span class=cl><span class=n>      version</span> <span class=o>=</span> <span class=s2>&#34;~&gt; 4.0&#34;</span>
</span></span><span class=line><span class=cl>    }
</span></span><span class=line><span class=cl>  }
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>Once this was added I ran a <code>terraform init</code> to initialise the terraform working directory.</p><h1 id=generating-the-cloudflare-terraform-code>Generating the Cloudflare terraform code</h1><p>This is where the magic happens. I was able to generate the Cloudflare terraform code from the terraform working directory by running the following command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cf-terraforming generate --resource-type <span class=s2>&#34;cloudflare_record&#34;</span> --zone <span class=nv>$CLOUDFLARE_ZONE_ID</span>
</span></span></code></pre></div><p>This outputted:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;cloudflare_record&#34; &#34;terraform_managed_resource_05e4f175dfbb21e818e9ff4e30e75796&#34;</span> {
</span></span><span class=line><span class=cl><span class=n>  name</span>    <span class=o>=</span> <span class=s2>&#34;samtripp.co.uk&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  proxied</span> <span class=o>=</span> <span class=kt>true</span>
</span></span><span class=line><span class=cl><span class=n>  ttl</span>     <span class=o>=</span> <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=n>  type</span>    <span class=o>=</span> <span class=s2>&#34;CNAME&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  value</span>   <span class=o>=</span> <span class=s2>&#34;dnsrecordvalue.co.uk&#34;</span>
</span></span><span class=line><span class=cl><span class=n>  zone_id</span> <span class=o>=</span> <span class=s2>&#34;myzoneid&#34;</span>
</span></span><span class=line><span class=cl>}
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span></code></pre></div><p>Perfect that worked as expected. I copied the output into a new file called <code>cloudflare-dns.tf</code>. I ran a <code>terraform plan</code> and saw that terraform wants to create the infrastructure. I need to import this resource into the terraform state to avoid destroying anything already configured. To do this I ran the following command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>cf-terraforming import --resource-type <span class=s2>&#34;cloudflare_record&#34;</span> --zone <span class=nv>$CLOUDFLARE_ZONE_ID</span>
</span></span></code></pre></div><p>This outputted:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>terraform import cloudflare_record.terraform_managed_resource_05e4f175dfbb21e818e9ff4e30e75796 myzoneid/05e4f175dfbb21e818e9ff4e30e75796
</span></span></code></pre></div><p>This command would be sufficiant to import the Cloudflare DNS record into terraform state. One thing I was not happy about was the names of these resources. As this was not in state yet I was able to manually edit the resource name to something more meaningful.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-hcl data-lang=hcl><span class=line><span class=cl><span class=k>resource</span> <span class=s2>&#34;cloudflare_record&#34; &#34;cname_root&#34;</span> {
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl>}
</span></span></code></pre></div><p>Once renamed I ran the terraform import command with the ammended name</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>terraform import cloudflare_record.cname_root myzoneid/05e4f175dfbb21e818e9ff4e30e75796
</span></span></code></pre></div><p>The Cloudflare DNS record is now in state. I was able to run a <code>terraform plan</code> and see there are no changes to be made to my infrastructure. If you have multiple DNS records like I did you may want to run import and then plan each time to ensure no issues. You will see the number of changes to be made decrease after each successful import.</p><h1 id=add-cloudflare-api-key-to-github-actions>Add Cloudflare API key to Github Actions</h1><p>Github Actions provides me with my all my Continuious Intergration and Continuous Delivery needs. I use <a href=https://github.com/dflook/terraform-github-actions>dflook/terraform-github-actions</a> to give me the functionality of running a terraform plan and apply when I make infrastructure changes. For Github Actions to interact with Cloudflare via Terraform I will need to add my API key to Github Actions. I managed this by navigating to my Github repository, select Settings > Secrets and Varibles > Actions > New Repository Secret. I named the secret CLOUDFLARE_API_TOKEN and then added the API token that I generated earlier. Once thats done I added the following lines to my Github actions .yaml file.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>env:
</span></span><span class=line><span class=cl>    CLOUDFLARE_API_TOKEN: <span class=si>${</span><span class=p>{ secrets.CLOUDFLARE_API_TOKEN </span><span class=si>}</span><span class=o>}</span>
</span></span></code></pre></div><h1 id=conclusion>Conclusion</h1><p>The cf-terraforming tool was straightforward to use and made the process of importing some of my Cloudflare configuration into Terraform a pain-free experience. Credit to all the developers involved in making this tool possible. I have also been able to import my page rules successfully following the same process as above. I will continued to use this tool to capure the rest of my Cloudflare configuration into Infrastructure-as-Code.</p><p>It does not support every resource type in the Cloudflare provider currently but it at least covers some of the critical ones that could be disruptive without being able to import it into my Terraform state.</p></article></main><footer id=footer>Copyright © 2021 - 2025 Sam Tripp - All Rights Reserved</footer></body></html>